name: Docker Build and Push

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    env:
      AT_USER: ${{ secrets.AT_USER }}
      AT_API_KEY: ${{ secrets.AT_API_KEY }}
      TC4A_DB_NAME: ${{ secrets.TC4A_DB_NAME }}
      TC4A_DB_USER: ${{ secrets.TC4A_DB_USER }}
      TC4A_DB_PASSWORD: ${{ secrets.TC4A_DB_PASSWORD }}
      TC4A_DB_HOST: ${{ secrets.TC4A_DB_HOST }}
      TC4A_DB_PORT: ${{ secrets.TC4A_DB_PORT }}
      FIREBASE_TYPE: ${{ secrets.FIREBASE_TYPE }}
      FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
      FIREBASE_PRIVATE_KEY_ID: ${{ secrets.FIREBASE_PRIVATE_KEY_ID }}
      FIREBASE_PRIVATE_KEY: ${{ secrets.FIREBASE_PRIVATE_KEY }}
      FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
      FIREBASE_CLIENT_ID: ${{ secrets.FIREBASE_CLIENT_ID }}
      FIREBASE_AUTH_URI: ${{ secrets.FIREBASE_AUTH_URI }}
      FIREBASE_TOKEN_URI: ${{ secrets.FIREBASE_TOKEN_URI }}
      FIREBASE_AUTH_PROVIDER_X509_CERT_URL: ${{ secrets.FIREBASE_AUTH_PROVIDER_X509_CERT_URL }}
      FIREBASE_CLIENT_X509_CERT_URL: ${{ secrets.FIREBASE_CLIENT_X509_CERT_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build -t tc4a:latest \
            --build-arg AT_USER="${AT_USER}" \
            --build-arg AT_API_KEY="${AT_API_KEY}" \
            --build-arg TC4A_DB_NAME="${TC4A_DB_NAME}" \
            --build-arg TC4A_DB_USER="${TC4A_DB_USER}" \
            --build-arg TC4A_DB_PASSWORD="${TC4A_DB_PASSWORD}" \
            --build-arg TC4A_DB_HOST="${TC4A_DB_HOST}" \
            --build-arg TC4A_DB_PORT="${TC4A_DB_PORT}" \
            --build-arg FIREBASE_TYPE="${FIREBASE_TYPE}" \
            --build-arg FIREBASE_PROJECT_ID="${FIREBASE_PROJECT_ID}" \
            --build-arg FIREBASE_PRIVATE_KEY_ID="${FIREBASE_PRIVATE_KEY_ID}" \
            --build-arg FIREBASE_PRIVATE_KEY="${FIREBASE_PRIVATE_KEY}" \
            --build-arg FIREBASE_CLIENT_EMAIL="${FIREBASE_CLIENT_EMAIL}" \
            --build-arg FIREBASE_CLIENT_ID="${FIREBASE_CLIENT_ID}" \
            --build-arg FIREBASE_AUTH_URI="${FIREBASE_AUTH_URI}" \
            --build-arg FIREBASE_TOKEN_URI="${FIREBASE_TOKEN_URI}" \
            --build-arg FIREBASE_AUTH_PROVIDER_X509_CERT_URL="${FIREBASE_AUTH_PROVIDER_X509_CERT_URL}" \
            --build-arg FIREBASE_CLIENT_X509_CERT_URL="${FIREBASE_CLIENT_X509_CERT_URL}" \
            .
        
      - name: Tag Docker image
        run: docker tag tc4a:latest ${{ secrets.DOCKER_USERNAME }}/tc4a:latest

      - name: Push Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/tc4a:latest
